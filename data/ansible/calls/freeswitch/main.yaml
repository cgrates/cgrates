---
- name: Set up environment in order to run call tests for Freeswitch
  hosts: all
  tasks:
    - name: Install freeswitch
      import_role:
        name: ../../roles/install_freeswitch
    - name: Install Go
      import_role:
        name: ../../roles/install_go

    - name: Install and config CGRateS
      import_role:
        name: ../../roles/install_cgrates

    - name:  Unzip FreeSWITCH config
      become: yes
      unarchive:
        src: "{{cgrates_dir}}/data/tutorial_tests/fs_evsock/freeswitch/etc/freeswitch_conf.tar.gz"
        dest: "{{cgrates_dir}}/data/tutorial_tests/fs_evsock/freeswitch/etc"
        remote_src: yes

    - name: Update internal.xml with the correct IP
      ansible.builtin.replace:
        path: "{{ cgrates_dir }}/data/tutorial_tests/fs_evsock/freeswitch/etc/freeswitch/sip_profiles/internal.xml"
        regexp: '192\.168\.56\.203'
        replace: "{{ ansible_host }}"

    - name:  Remove FreeSWITCH default config from /etc/freeswitch
      become: yes
      file:
        state: absent
        path: /etc/freeswitch

    - name:  Copy our custom config for FreeSWITCH in /etc/freeswitch
      become: yes
      ansible.builtin.copy:
        src: "{{ cgrates_dir }}/data/tutorial_tests/fs_evsock/freeswitch/etc/freeswitch"
        dest: /etc
        remote_src: yes

    - name: Configure PJSUA
      import_role:
        name: ../../roles/install_pjsua
