---
- hosts: all
  vars:
    ansible_python_interpreter: auto # to disable deprication warning related to the use of python2
    ###############################################################
    ##################### Golang Vars #############################
    ###############################################################
    # Go language SDK version number
    golang_version: '1.20.1'
    go_version_target: "go version go{{ golang_version }} linux/amd64"
    # Mirror to download the Go language SDK redistributable package from
    golang_mirror: 'https://storage.googleapis.com/golang'
    # Base installation directory the Go language SDK distribution
    golang_install_dir: '/usr/local/go'
    # Directory to store files downloaded for Go language SDK installation
    golang_download_dir: "{{ x_ansible_download_dir | default(ansible_env.HOME + '/.ansible/tmp/downloads') }}"
    # Location for GOPATH environment variable
    golang_gopath: "/home/{{ user }}/go"
    # Filename of Go language SDK redistributable package
    golang_redis_filename: 'go{{ golang_version }}.linux-amd64.tar.gz'
    ###############################################################
    # CGRateS location
    cgrates_dir: "{{ golang_gopath }}/src/github.com/cgrates/cgrates"

    rootUser : root

    freeswitch_packages:
      - freeswitch-meta-all
      - freeswitch-mod-json-cdr

    dependencies:
      - build-essential
      - git
      - redis-server
      - mariadb-server
      - postgresql
      - postgresql-contrib
      - python-dev
      - gcc
      - make
      - binutils
      - libasound2-dev
      - gnupg2
      - lsb-release

    customPath: "{{ lookup('env','PATH') }}:{{ golang_gopath }}/bin:/usr/local/go/bin:{{ ansible_env.PATH }}"

  remote_user: '{{ user }}'
  tasks:
    ###########################################################################################################################
    # Install dependencies
    - name: Install dependencies
      become: yes
      apt: name={{ dependencies }} state=present

    ###########################################################################################################################
    # Install FreeSWITCH
    # - name:  Install FreeSWITCH
    #   become: yes
    #   shell: |
    #     apt-get update && apt-get install -y gnupg2 wget lsb-release
    #     wget --http-user=signalwire --http-password={{ signalwire_token }} -O /usr/share/keyrings/signalwire-freeswitch-repo.gpg https://freeswitch.signalwire.com/repo/deb/debian-release/signalwire-freeswitch-repo.gpg
    #     echo "machine freeswitch.signalwire.com login signalwire password {{ signalwire_token }}" > /etc/apt/auth.conf
    #     chmod 600 /etc/apt/auth.conf
    #     echo "deb [signed-by=/usr/share/keyrings/signalwire-freeswitch-repo.gpg] https://freeswitch.signalwire.com/repo/deb/debian-release/ `lsb_release -sc` main" > /etc/apt/sources.list.d/freeswitch.list
    #     echo "deb-src [signed-by=/usr/share/keyrings/signalwire-freeswitch-repo.gpg] https://freeswitch.signalwire.com/repo/deb/debian-release/ `lsb_release -sc` main" >> /etc/apt/sources.list.d/freeswitch.list
    #     apt-get update && apt-get install -y freeswitch-meta-all
    - name: Fetch password protected FreeSWITCH GPG key
      become: yes
      no_log: true
      get_url:
        url: https://freeswitch.signalwire.com/repo/deb/debian-release/signalwire-freeswitch-repo.gpg
        username: signalwire
        password: '{{ signalwire_token }}'
        dest: /usr/share/keyrings/signalwire-freeswitch-repo.gpg

    - name: Make apt auth directory
      become: yes
      ansible.builtin.file:
        path: /etc/apt/auth.conf.d
        state: directory
        mode: '0755'

    - name: Create apt auth.conf.d freeswitch file
      become: yes
      ansible.builtin.copy:
        dest: /etc/apt/auth.conf.d/freeswitch.conf
        owner: root
        group: root
        mode: '0700'
        content: 'machine freeswitch.signalwire.com login signalwire password {{ signalwire_token }}'

    - name: Add SignalWire FreeSWITCH repo
      become: yes
      ansible.builtin.apt_repository:
        repo: deb [signed-by=/usr/share/keyrings/signalwire-freeswitch-repo.gpg] https://freeswitch.signalwire.com/repo/deb/debian-release/ {{ ansible_distribution_release }} main
        state: present
        filename: freeswitch

    - name: Install FreeSWITCH
      become: yes
      ansible.builtin.apt:
        update_cache: yes
        name: '{{ freeswitch_packages }}'
        state: present
  
    ###########################################################################################################################
    # Install Go
    - name: install unarchive dependencies (zypper)
      become: yes
      zypper:
        name:
          - gzip
          - tar
        state: present
      when: ansible_pkg_mgr == 'zypper'

    - name: Install Go
      include: go.yaml

    ###########################################################################################################################
    # Install and config CGRateS
    - name: Install and config CGRateS
      include: cgrates.yaml

    ###########################################################################################################################
    # Configure FreeSWITCH
    - name:  Unzip FreeSWITCH config
      become: yes
      unarchive:
        src: "{{cgrates_dir}}/data/tutorial_tests/fs_evsock/freeswitch/etc/freeswitch_conf.tar.gz"
        dest: "{{cgrates_dir}}/data/tutorial_tests/fs_evsock/freeswitch/etc"
        remote_src: yes

    - name:  Remove FreeSWITCH default config from /etc/freeswitch
      become: yes
      file:
        state: absent
        path: /etc/freeswitch

    - name:  Copy our custom config for FreeSWITCH in /etc/freeswitch
      become: yes
      ansible.builtin.copy:
        src: "{{ cgrates_dir }}/data/tutorial_tests/fs_evsock/freeswitch/etc/freeswitch"
        dest: /etc
        remote_src: yes

    - name: Add user for CGRateS
      become: yes
      shell: 'sudo useradd cgrates'

    # Configure PJSUA
    - name: Config PJSUA
      include: pjsua.yaml
