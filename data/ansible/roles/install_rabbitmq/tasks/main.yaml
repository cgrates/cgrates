# tasks/main.yml
---
- name: Install RabbitMQ dependencies
  become: yes
  apt:
    name: "{{ rabbitmq_dependencies }}"
    state: present
    update_cache: yes
    cache_valid_time: 86400

- name: Import RabbitMQ's main signing key
  become: yes
  shell: |
    curl -1sLf "https://keys.openpgp.org/vks/v1/by-fingerprint/0A9AF2115F4687BD29803A206B73A36E6026DFCA" | sudo gpg --dearmor | sudo tee /usr/share/keyrings/com.rabbitmq.team.gpg > /dev/null

- name: Download Erlang GPG key
  become: yes
  shell: |
    curl -1sLf "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xf77f1eda57ebb1cc" | sudo gpg --dearmor | sudo tee /usr/share/keyrings/net.launchpad.ppa.rabbitmq.erlang.gpg > /dev/null

- name: Import PackageCloud RabbitMQ repository
  become: yes
  shell: |
    curl -1sLf "https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey" | sudo gpg --dearmor | sudo tee /usr/share/keyrings/io.packagecloud.rabbitmq.gpg > /dev/null

- name: Add apt repositories maintained by Team RabbitMQ
  become: yes
  copy:
    dest: "/etc/apt/sources.list.d/rabbitmq.list"
    content: |
      deb [signed-by=/usr/share/keyrings/net.launchpad.ppa.rabbitmq.erlang.gpg] http://ppa.launchpad.net/rabbitmq/rabbitmq-erlang/ubuntu bionic main
      deb-src [signed-by=/usr/share/keyrings/net.launchpad.ppa.rabbitmq.erlang.gpg] http://ppa.launchpad.net/rabbitmq/rabbitmq-erlang/ubuntu bionic main
      deb [signed-by=/usr/share/keyrings/io.packagecloud.rabbitmq.gpg] https://packagecloud.io/rabbitmq/rabbitmq-server/ubuntu/ bionic main
      deb-src [signed-by=/usr/share/keyrings/io.packagecloud.rabbitmq.gpg] https://packagecloud.io/rabbitmq/rabbitmq-server/ubuntu/ bionic main

- name: Install Erlang packages
  become: yes
  apt:
    name: "{{ erlang_packages }}"
    state: present
    update_cache: yes

- name: Install rabbitmq-server and its dependencies
  become: yes
  apt:
    name: rabbitmq-server
    state: present
    update_cache: yes
